<!doctype html>
{% import 'macros.html' as macs %}
<html>
<head>
    <title>Coronavirus (COVID-19)</title>
    <link rel="icon" href="static/favicon.png">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">

    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>

    <script type="text/javascript" class="init">

    $.fn.dataTable.ext.order['dom-checkbox'] = function  ( settings, col ){
      return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        return $(td).closest('tr').hasClass('selected') ? '1' : '0';
      } );
    }
    

    $(document).ready(function() {
        var table = $('#countries').DataTable({
           "stateSave": true,
           "stateDuration": 0,
           "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],

           columnDefs: [{
              orderable: true,
              className: 'select-checkbox',
              targets: 0,
                    orderDataType: 'dom-checkbox'
            }],
            select: {
              style: 'multi',
              selector: 'td:first-child'
            },
            order: [
              [0, 'desc'],[2, 'desc']
            ]
        });

        table
            .on( 'select', saveSelections)
            .on( 'deselect', saveSelections);
        
        loadSelections();
        loadCharts(table);

        $('#updateBtn').click(function(){
            loadCharts(table);
        });

        function loadSelections(){
            rks = localStorage.rowKeyStore;
            
            if(!rks){
                rks = "{{data['default_countries']}}"
            }
            
            var rowKeys = JSON.parse(rks);
            for (var key in rowKeys){
                table.row(rowKeys[key]).select()
            }
            table.draw()
            
        }

        function saveSelections(){
            var sel = table.rows( { selected: true } );
            localStorage.rowKeyStore = JSON.stringify(sel[0]);
        }

    });

    function loadCharts(table){
        var sel = table.rows( {  selected: true, order: 'applied' } );
        q = JSON.stringify(sel[0]);
        $('#countries_last_day').load('/countries_last_day?countries='+q);
    }

    
    </script>
    {{ macs.cookieconsent_head() }}
</head>
<body>
    <h1>Coronavirus (COVID-19)</h1>
    <p>Reported Cases by Country (Data updated {{ data['commit_date'] }}, Last day {{ data['last_date'].strftime("%b %d, %Y") }})</p>
    <table id="countries" class="display">
        <thead>
            <tr>
                <th></th>
                <th>Country</th>
                <th>Confirmed</th>
                <th>Recovered</th>
                <th>Deaths</th>
            </tr>
        </thead>
        <tbody>
            {% for key, value in data['last_day'].iterrows() %}
            <tr>
                <td></td>
                
                <td><a href="country?name={{ key }}" target="_blank">{{ key }}</a> </td>
                <td> {{ value['Confirmed'] }} </td>
                <td> {{ value['Recovered'] }} </td>
                <td> {{ value['Deaths'] }} </td>
            </tr>
            {% endfor %} 
        </tbody>
    </table>

    <input type="button" id="updateBtn" value="Update Charts" />
    <div id="countries_last_day"></div>

    {{ macs.cookieconsent_body() }}
</body>
</html>